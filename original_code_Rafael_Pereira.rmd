
This gist shows in two steps **how to tilt and stack maps using ggplot2** in order to create an image like this one:
[![enter image description here][1]][1]

Let's load the necessary libraries and data to use a reproducible example:
``` {r load libraries and data}
# load libraries
  library(rgeos)
  library(UScensus2000tract)
  library(ggplot2)
  library(dplyr)
  library(rgdal)
  library(RColorBrewer)
  require(gstat)
  require(sp)
  require(spatstat)
  
# set working dir
setwd("~/Sites/corso-r-sod16")

# load data
staz_meteo = readOGR("data/meteo_trent.geojson", "OGRGeoJSON")
plot(staz_meteo)
# 
# # plot Census Tract map
#   plot(oregon.tract)
```

## 0th Step: create IDW interpolator

``` {r IDW}

x.range <- as.numeric(range(staz_meteo@coords[,1]))  # min/max longitude of the interpolation area
y.range <- as.numeric(range(staz_meteo@coords[,2]))  # min/max latitude of the interpolation area


grd <- expand.grid(x = seq(from = x.range[1], to = x.range[2], by = 0.01), y = seq(from = y.range[1], to = y.range[2], by = 0.01))  # expand points to grid
## convert grid to SpatialPixel class
coordinates(grd) <- ~ x+y
gridded(grd) <- TRUE

plot(grd, cex = 1.5, col = "grey")
points(staz_meteo, pch = 1, col = "red", cex = 1)

proj4string(grd) <- '+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs'
spTransform(staz_meteo, CRS='+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs')
  

idw <- idw(formula = as.numeric(end) ~ 1, locations = staz_meteo, newdata = grd)  # apply idw model for the data


idw.output = as.data.frame(idw)  # output is defined as a data table
names(idw.output)[1:3] <- c("long", "lat", "var1.pred")  # give names to the modelled variables

# Plot the results:
ggplot() + geom_tile(data = idw.output, aes(x = long, y = lat, fill = var1.pred)) + 
    geom_point(data = staz_meteo@data, aes(x = staz_meteo@coords[,1], y = staz_meteo@coords[,2]), shape = 21, 
        colour = "red")





x.range <- as.numeric(c(21.76, 28.21))  # min/max longitude of the interpolation area
y.range <- as.numeric(c(57.45, 59.72))  # min/max latitude of the interpolation area
Create a data frame from all combinations of the supplied vectors or factors. See the description of the return value for precise details of the way this is done. Set spatial coordinates to create a Spatial object. Assign gridded structure:




idw0(formula, data, newdata, y, idp = 2.0)
idw(z~1, staz_meteo)


# merdate:
staz_meteo_data = as.data.frame(staz_meteo)
staz_meteo_data <- staz_meteo_data[, c(19,20,1:18)]

colnames(staz_meteo_data)  <- c('x','y', colnames(staz_meteo_data)[3:20])

staz_meteo_ppp = as.ppp(staz_meteo_data, c(0,1,0,1), fatal=TRUE)

IDW = idw(X, power=2, at="pixels", ...)
```


## 1st step: tilting maps
The 1st step is to tilt the map. This code comes from [Barry Rowlingson's](http://barry.rowlingson.com/) answer to a question on [gis.stackexchange](http://gis.stackexchange.com/questions/189490/plot-tilted-map-in-r). Thanks [Barry](https://twitter.com/geospacedman)! The idea here is to use a shear and a scale matrix to transform the coordinates of the spatial object once it has been fortified.

```{r tilt map}
# create a unique character ID value:
  oregon.tract$id=as.character(1:nrow(oregon.tract))

# Fortify on that ID and join attribute data:
  ofort <- fortify(oregon.tract,region="id")
  ofort <- left_join(ofort, oregon.tract@data, c("id"="id"))

# Shear/scale matrix [[2,1],[0,1]] obtained by some trial and error:
  sm <- matrix(c(2,1.2,0,1),2,2)

# Get transformed coordinates:
  xy <- as.matrix(ofort[,c("long","lat")]) %*% sm

# Add xy as extra columns in fortified data:
  ofort$x <- xy[,1]; ofort$y = xy[,2]

# Plot !
  ggplot(ofort, aes(x=x, y=y, group=id, fill=white)) + geom_polygon() + coord_fixed()
```
[![enter image description here][2]][2]


## 2nd step: stacking maps
The 2nd step is to stack different layers of the map. To do this, you just need to add another map layer and displace its `y` axis: e.g. `aes(x=x, y=y+5)` :

```{r Stack map}
    ggplot(data= ofort) + 
      geom_polygon( aes(x=x, y=y, group=id), fill= "white", color="gray30") + # layer 1
      geom_polygon( aes(x=x, y=y+5, group=id, fill=white)) +                  # layer 2
      geom_polygon( aes(x=x, y=y+10, group=id, fill=pop2000-white)) +         # layer 3
      theme(axis.text=element_blank(), axis.ticks=element_blank()) +
      scale_fill_distiller(palette = "RdBu", name = "Population") +
      annotate("text", x = -197, y = 45, size=5, color="gray35", label = "Census tracts") + # layer 1
      annotate("text", x = -197, y = 50, size=5, color="gray35", label = "White") +         # layer 2
      annotate("text", x = -197, y = 55, size=5, color="gray35", label = "Non-white") +     # layer 3
      coord_fixed()
```
[![enter image description here][1]][1]



  [1]: http://i.stack.imgur.com/3lbAT.png
  [2]: http://i.stack.imgur.com/kU1nZ.png
